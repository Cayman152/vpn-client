name: Ghost VPN Windows Build

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Optional release tag (example: v0.1.0)"
        required: false
        type: string

permissions:
  contents: write

env:
  OutputPath64: "${{ github.workspace }}\\build\\ghost-vpn-windows-64"
  ArtifactDir: "${{ github.workspace }}\\artifacts"
  ZipPath64: "${{ github.workspace }}\\artifacts\\GhostVPN-windows-x64.zip"
  SetupPath64: "${{ github.workspace }}\\artifacts\\GhostVPN-Setup-x64.exe"

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.0.x"

      - name: Patch GlobalHotKeys nullable warning
        shell: pwsh
        run: |
          $file = "./v2rayN/GlobalHotKeys/src/GlobalHotKeys/HotKeyManager.cs"
          if (-not (Test-Path $file)) {
            throw "GlobalHotKeys source file not found: $file"
          }
          $content = Get-Content -Path $file -Raw
          $patched = $content.Replace("GetModuleHandle(null);", "GetModuleHandle(null!);")
          if ($patched -ne $content) {
            Set-Content -Path $file -Value $patched -Encoding utf8
          }

      - name: Resolve app version
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.release_tag }}".Trim()
          if ($tag) {
            if ($tag.StartsWith("v")) {
              $tag = $tag.Substring(1)
            }
            $version = $tag
          }
          else {
            [xml]$props = Get-Content "./v2rayN/Directory.Build.props"
            $baseVersion = $props.Project.PropertyGroup[0].Version
            $version = "$baseVersion.${{ github.run_number }}"
          }
          "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build win-x64
        shell: pwsh
        run: |
          dotnet publish ./v2rayN/v2rayN.Desktop/v2rayN.Desktop.csproj -c Release -r win-x64 -p:SelfContained=true -p:EnableWindowsTargeting=true -p:TreatWarningsAsErrors=false -p:WarningsAsErrors= -p:NoWarn=CS8625 -o "$env:OutputPath64"
          dotnet publish ./v2rayN/AmazTool/AmazTool.csproj -c Release -r win-x64 -p:SelfContained=true -p:EnableWindowsTargeting=true -p:TreatWarningsAsErrors=false -p:WarningsAsErrors= -p:NoWarn=CS8625 -o "$env:OutputPath64"

      - name: Download core binaries (xray/sing-box)
        shell: pwsh
        run: |
          $tmpRoot = Join-Path $env:RUNNER_TEMP "ghostvpn-cores"
          New-Item -ItemType Directory -Path $tmpRoot -Force | Out-Null

          function Ensure-CoreLayout {
            param([string]$BinTarget)

            function Ensure-CoreSubdir {
              param(
                [string]$CoreDirName,
                [string[]]$ExeNames
              )

              $coreDir = Join-Path $BinTarget $CoreDirName
              New-Item -ItemType Directory -Path $coreDir -Force | Out-Null

              $alreadyPresent = $ExeNames | ForEach-Object { Join-Path $coreDir $_ } | Where-Object { Test-Path $_ } | Select-Object -First 1
              if ($alreadyPresent) {
                return
              }

              foreach ($exeName in $ExeNames) {
                $candidate = Get-ChildItem -Path $BinTarget -File -Recurse -ErrorAction SilentlyContinue |
                  Where-Object { $_.Name -ieq $exeName } |
                  Select-Object -First 1

                if ($candidate) {
                  Copy-Item -Path (Join-Path $candidate.Directory.FullName "*") -Destination $coreDir -Recurse -Force
                  return
                }

                $flatCandidate = Join-Path $BinTarget $exeName
                if (Test-Path $flatCandidate) {
                  Copy-Item -Path $flatCandidate -Destination (Join-Path $coreDir $exeName) -Force
                  return
                }
              }
            }

            Ensure-CoreSubdir -CoreDirName "xray" -ExeNames @("xray.exe")
            Ensure-CoreSubdir -CoreDirName "sing_box" -ExeNames @("sing-box.exe", "sing-box-client.exe")
          }

          function Add-CoreBin {
            param(
              [string]$Arch,
              [string]$OutPath
            )

            $zipPath = Join-Path $tmpRoot "v2rayN-$Arch.zip"
            $extractPath = Join-Path $tmpRoot "extract-$Arch"
            $urls = @(
              "https://raw.githubusercontent.com/2dust/v2rayN-core-bin/master/v2rayN-$Arch.zip",
              "https://raw.githubusercontent.com/2dust/v2rayN-core-bin/main/v2rayN-$Arch.zip",
              "https://github.com/2dust/v2rayN-core-bin/raw/refs/heads/master/v2rayN-$Arch.zip",
              "https://github.com/2dust/v2rayN-core-bin/raw/refs/heads/main/v2rayN-$Arch.zip"
            )

            $downloaded = $false
            foreach ($url in $urls) {
              try {
                Invoke-WebRequest -Uri $url -OutFile $zipPath -ErrorAction Stop
                if ((Get-Item $zipPath).Length -gt 0) {
                  $downloaded = $true
                  break
                }
              }
              catch {
                Write-Host "Failed to download core package from: $url"
              }
            }

            if (-not $downloaded) {
              throw "Failed to download core package for $Arch from all known URLs"
            }

            Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

            $binSource = Get-ChildItem -Path $extractPath -Directory -Recurse |
              Where-Object { $_.Name -eq "bin" } |
              Select-Object -First 1

            if (-not $binSource) {
              throw "bin folder not found in core package for $Arch"
            }

            $binTarget = Join-Path $OutPath "bin"
            New-Item -ItemType Directory -Path $binTarget -Force | Out-Null
            Copy-Item -Path (Join-Path $binSource.FullName "*") -Destination $binTarget -Recurse -Force
            Ensure-CoreLayout -BinTarget $binTarget
          }

          Add-CoreBin -Arch "windows-64" -OutPath $env:OutputPath64

      - name: Verify bundled core binaries
        shell: pwsh
        run: |
          function Assert-CoreFiles {
            param([string]$OutPath, [string]$ArchLabel)

            $xray = Join-Path $OutPath "bin\\xray\\xray.exe"
            if (-not (Test-Path $xray)) {
              throw "Missing required core file for ${ArchLabel}: $xray"
            }

            $singBoxCandidates = @(
              (Join-Path $OutPath "bin\\sing_box\\sing-box.exe"),
              (Join-Path $OutPath "bin\\sing_box\\sing-box-client.exe")
            )
            $hasSingBox = $singBoxCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
            if (-not $hasSingBox) {
              $joined = ($singBoxCandidates -join ", ")
              throw "Missing required sing-box executable for ${ArchLabel}. Checked: $joined"
            }
          }

          Assert-CoreFiles -OutPath $env:OutputPath64 -ArchLabel "win-x64"

      - name: Package zip archives
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "$env:ArtifactDir" -Force | Out-Null
          Compress-Archive -Path "$env:OutputPath64\\*" -DestinationPath "$env:ZipPath64" -Force

      - name: Build setup installer (x64)
        shell: pwsh
        run: |
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            choco install innosetup --no-progress -y
          }
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            throw "Inno Setup compiler not found"
          }

          New-Item -ItemType Directory -Path "$env:ArtifactDir" -Force | Out-Null
          & $iscc "/DMyAppVersion=$env:APP_VERSION" "/DSourceDir=$env:OutputPath64" "/DOutputDir=$env:ArtifactDir" "./installer/ghost-vpn.iss"

          if (-not (Test-Path $env:SetupPath64)) {
            $builtInstaller = Get-ChildItem -Path $env:ArtifactDir -Filter "*.exe" -File | Select-Object -First 1
            if (-not $builtInstaller) {
              throw "Setup installer was not created"
            }
            Move-Item -Path $builtInstaller.FullName -Destination $env:SetupPath64 -Force
          }

      - name: Upload windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ghost-vpn-windows
          path: |
            ${{ env.ZipPath64 }}
            ${{ env.SetupPath64 }}
          retention-days: 14

      - name: Publish build summary
        shell: pwsh
        run: |
          @"
          ## Ghost VPN build artifacts
          - Artifact name: ghost-vpn-windows
          - File 1: GhostVPN-windows-x64.zip
          - File 2: GhostVPN-Setup-x64.exe
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Upload archives to GitHub Release
        if: ${{ github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          prerelease: true
          files: |
            ${{ env.ZipPath64 }}
            ${{ env.SetupPath64 }}
