name: Ghost VPN Windows Build

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Optional release tag (example: v0.1.0)"
        required: false
        type: string

permissions:
  contents: write

env:
  OutputPath64: "${{ github.workspace }}\\build\\ghost-vpn-windows-64"
  ArtifactDir: "${{ github.workspace }}\\artifacts"
  ZipPath64: "${{ github.workspace }}\\artifacts\\GhostVPN-windows-x64.zip"
  SetupPath64: "${{ github.workspace }}\\artifacts\\GhostVPN-Setup-x64.exe"

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Resolve source paths
        shell: pwsh
        run: |
          $sourceRoot = (Resolve-Path "./GhostVPN").Path
          $desktopProject = Join-Path $sourceRoot "GhostVPN.Desktop\\GhostVPN.Desktop.csproj"
          $amazToolProject = Join-Path $sourceRoot "AmazTool\\AmazTool.csproj"
          $propsPath = Join-Path $sourceRoot "Directory.Build.props"
          $globalHotKeysFile = Join-Path $sourceRoot "GlobalHotKeys\\src\\GlobalHotKeys\\HotKeyManager.cs"

          foreach ($requiredPath in @($desktopProject, $amazToolProject, $propsPath, $globalHotKeysFile)) {
            if (-not (Test-Path $requiredPath)) {
              throw "Required path not found: $requiredPath"
            }
          }

          "SOURCE_ROOT=$sourceRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "PROJECT_DESKTOP=$desktopProject" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "PROJECT_AMAZTOOL=$amazToolProject" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "PROPS_PATH=$propsPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "GLOBAL_HOTKEYS_FILE=$globalHotKeysFile" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Patch GlobalHotKeys nullable warning
        shell: pwsh
        run: |
          $content = Get-Content -Path $env:GLOBAL_HOTKEYS_FILE -Raw
          $patched = $content.Replace("GetModuleHandle(null);", "GetModuleHandle(null!);")
          if ($patched -ne $content) {
            Set-Content -Path $env:GLOBAL_HOTKEYS_FILE -Value $patched -Encoding utf8
          }

      - name: Resolve app version
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.release_tag }}".Trim()
          if ($tag) {
            if ($tag.StartsWith("v")) {
              $tag = $tag.Substring(1)
            }
            $version = $tag
          }
          else {
            [xml]$props = Get-Content $env:PROPS_PATH
            $baseVersion = $props.Project.PropertyGroup[0].Version
            $version = "$baseVersion.${{ github.run_number }}"
          }
          "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build win-x64
        shell: pwsh
        run: |
          dotnet publish "$env:PROJECT_DESKTOP" -c Release -r win-x64 -p:SelfContained=true -p:EnableWindowsTargeting=true -p:TreatWarningsAsErrors=false -p:WarningsAsErrors= -p:NoWarn=CS8625 -o "$env:OutputPath64"
          dotnet publish "$env:PROJECT_AMAZTOOL" -c Release -r win-x64 -p:SelfContained=true -p:EnableWindowsTargeting=true -p:TreatWarningsAsErrors=false -p:WarningsAsErrors= -p:NoWarn=CS8625 -o "$env:OutputPath64"

      - name: Download core binaries (xray/sing-box)
        shell: pwsh
        run: |
          $headers = @{
            "User-Agent" = "ghost-vpn-build"
            "Accept" = "application/vnd.github+json"
          }

          $tmpRoot = Join-Path $env:RUNNER_TEMP "ghostvpn-cores"
          New-Item -ItemType Directory -Path $tmpRoot -Force | Out-Null

          function Get-LatestAsset {
            param(
              [string]$Repo,
              [string]$Pattern
            )

            $release = Invoke-RestMethod -Uri "https://api.github.com/repos/$Repo/releases/latest" -Headers $headers
            $asset = $release.assets | Where-Object { $_.name -match $Pattern } | Select-Object -First 1

            if (-not $asset) {
              throw "No asset matched pattern '$Pattern' for repository '$Repo'"
            }

            return [PSCustomObject]@{
              Tag = $release.tag_name
              Name = $asset.name
              Url = $asset.browser_download_url
            }
          }

          function Install-CoreFromZip {
            param(
              [string]$DownloadUrl,
              [string]$ZipName,
              [string]$ExecutableName,
              [string]$TargetDir
            )

            $zipPath = Join-Path $tmpRoot $ZipName
            $extractPath = Join-Path $tmpRoot ([System.IO.Path]::GetFileNameWithoutExtension($ZipName))

            Invoke-WebRequest -Uri $DownloadUrl -OutFile $zipPath
            Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

            $exePath = Get-ChildItem -Path $extractPath -File -Recurse |
              Where-Object { $_.Name -ieq $ExecutableName } |
              Select-Object -First 1

            if (-not $exePath) {
              throw "Executable '$ExecutableName' not found in package '$ZipName'"
            }

            New-Item -ItemType Directory -Path $TargetDir -Force | Out-Null
            Copy-Item -Path (Join-Path $exePath.Directory.FullName "*") -Destination $TargetDir -Recurse -Force
          }

          $xrayAsset = Get-LatestAsset -Repo "XTLS/Xray-core" -Pattern "^Xray-windows-64\\.zip$"
          $singBoxAsset = Get-LatestAsset -Repo "SagerNet/sing-box" -Pattern "^sing-box-.*-windows-amd64\\.zip$"

          $xrayTarget = Join-Path $env:OutputPath64 "bin\\xray"
          $singBoxTarget = Join-Path $env:OutputPath64 "bin\\sing_box"

          Install-CoreFromZip -DownloadUrl $xrayAsset.Url -ZipName $xrayAsset.Name -ExecutableName "xray.exe" -TargetDir $xrayTarget
          Install-CoreFromZip -DownloadUrl $singBoxAsset.Url -ZipName $singBoxAsset.Name -ExecutableName "sing-box.exe" -TargetDir $singBoxTarget

      - name: Verify bundled core binaries
        shell: pwsh
        run: |
          function Assert-CoreFiles {
            param([string]$OutPath, [string]$ArchLabel)

            $xray = Join-Path $OutPath "bin\\xray\\xray.exe"
            if (-not (Test-Path $xray)) {
              throw "Missing required core file for ${ArchLabel}: $xray"
            }

            $singBoxCandidates = @(
              (Join-Path $OutPath "bin\\sing_box\\sing-box.exe"),
              (Join-Path $OutPath "bin\\sing_box\\sing-box-client.exe")
            )
            $hasSingBox = $singBoxCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
            if (-not $hasSingBox) {
              $joined = ($singBoxCandidates -join ", ")
              throw "Missing required sing-box executable for ${ArchLabel}. Checked: $joined"
            }
          }

          Assert-CoreFiles -OutPath $env:OutputPath64 -ArchLabel "win-x64"

      - name: Package zip archives
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "$env:ArtifactDir" -Force | Out-Null
          Compress-Archive -Path "$env:OutputPath64\\*" -DestinationPath "$env:ZipPath64" -Force

      - name: Build setup installer (x64)
        shell: pwsh
        run: |
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            choco install innosetup --no-progress -y
          }
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            throw "Inno Setup compiler not found"
          }

          New-Item -ItemType Directory -Path "$env:ArtifactDir" -Force | Out-Null
          & $iscc "/DMyAppVersion=$env:APP_VERSION" "/DSourceDir=$env:OutputPath64" "/DOutputDir=$env:ArtifactDir" "./installer/ghost-vpn.iss"

          if (-not (Test-Path $env:SetupPath64)) {
            $builtInstaller = Get-ChildItem -Path $env:ArtifactDir -Filter "*.exe" -File | Select-Object -First 1
            if (-not $builtInstaller) {
              throw "Setup installer was not created"
            }
            Move-Item -Path $builtInstaller.FullName -Destination $env:SetupPath64 -Force
          }

      - name: Upload windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ghost-vpn-windows
          path: |
            ${{ env.ZipPath64 }}
            ${{ env.SetupPath64 }}
          retention-days: 14

      - name: Publish build summary
        shell: pwsh
        run: |
          @"
          ## Ghost VPN build artifacts
          - Artifact name: ghost-vpn-windows
          - File 1: GhostVPN-windows-x64.zip
          - File 2: GhostVPN-Setup-x64.exe
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Upload archives to GitHub Release
        if: ${{ github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          prerelease: true
          files: |
            ${{ env.ZipPath64 }}
            ${{ env.SetupPath64 }}
