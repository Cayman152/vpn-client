name: Ghost VPN Windows Build

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Optional release tag (example: v0.1.0)"
        required: false
        type: string

permissions:
  contents: write

env:
  OutputPath64: "${{ github.workspace }}\\v2rayN\\Release\\ghost-vpn-windows-64"
  OutputPathArm64: "${{ github.workspace }}\\v2rayN\\Release\\ghost-vpn-windows-arm64"
  ZipPath64: "${{ github.workspace }}\\ghost-vpn-windows-64.zip"
  ZipPathArm64: "${{ github.workspace }}\\ghost-vpn-windows-arm64.zip"
  InstallerOutputDir: "${{ github.workspace }}\\v2rayN\\Release\\installer"
  SetupPath64: "${{ github.workspace }}\\v2rayN\\Release\\installer\\GhostVPN-Setup-x64.exe"

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          submodules: "recursive"
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5.0.1
        with:
          dotnet-version: "8.0.x"

      - name: Resolve app version
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.release_tag }}".Trim()
          if ($tag) {
            if ($tag.StartsWith("v")) {
              $tag = $tag.Substring(1)
            }
            $version = $tag
          }
          else {
            [xml]$props = Get-Content "./v2rayN/Directory.Build.props"
            $baseVersion = $props.Project.PropertyGroup[0].Version
            $version = "$baseVersion.${{ github.run_number }}"
          }
          "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build win-x64
        shell: pwsh
        run: |
          dotnet publish ./v2rayN/v2rayN.Desktop/v2rayN.Desktop.csproj -c Release -r win-x64 -p:SelfContained=true -p:EnableWindowsTargeting=true -o "$env:OutputPath64"
          dotnet publish ./v2rayN/AmazTool/AmazTool.csproj -c Release -r win-x64 -p:SelfContained=true -p:EnableWindowsTargeting=true -p:PublishTrimmed=true -o "$env:OutputPath64"

      - name: Build win-arm64
        shell: pwsh
        run: |
          dotnet publish ./v2rayN/v2rayN.Desktop/v2rayN.Desktop.csproj -c Release -r win-arm64 -p:SelfContained=true -p:EnableWindowsTargeting=true -o "$env:OutputPathArm64"
          dotnet publish ./v2rayN/AmazTool/AmazTool.csproj -c Release -r win-arm64 -p:SelfContained=true -p:EnableWindowsTargeting=true -p:PublishTrimmed=true -o "$env:OutputPathArm64"

      - name: Download core binaries (xray/sing-box)
        shell: pwsh
        run: |
          $tmpRoot = Join-Path $env:RUNNER_TEMP "ghostvpn-cores"
          New-Item -ItemType Directory -Path $tmpRoot -Force | Out-Null

          function Add-CoreBin {
            param(
              [string]$Arch,
              [string]$OutPath
            )

            $zipPath = Join-Path $tmpRoot "v2rayN-$Arch.zip"
            $extractPath = Join-Path $tmpRoot "extract-$Arch"
            $url = "https://github.com/2dust/v2rayN-core-bin/raw/refs/heads/master/v2rayN-$Arch.zip"

            Invoke-WebRequest -Uri $url -OutFile $zipPath
            Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

            $binSource = Get-ChildItem -Path $extractPath -Directory -Recurse |
              Where-Object { $_.Name -eq "bin" } |
              Select-Object -First 1

            if (-not $binSource) {
              throw "bin folder not found in core package for $Arch"
            }

            $binTarget = Join-Path $OutPath "bin"
            New-Item -ItemType Directory -Path $binTarget -Force | Out-Null
            Copy-Item -Path (Join-Path $binSource.FullName "*") -Destination $binTarget -Recurse -Force
          }

          Add-CoreBin -Arch "windows-64" -OutPath $env:OutputPath64
          Add-CoreBin -Arch "windows-arm64" -OutPath $env:OutputPathArm64

      - name: Package zip archives
        shell: pwsh
        run: |
          Compress-Archive -Path "$env:OutputPath64\\*" -DestinationPath "$env:ZipPath64" -Force
          Compress-Archive -Path "$env:OutputPathArm64\\*" -DestinationPath "$env:ZipPathArm64" -Force

      - name: Build setup installer (x64)
        shell: pwsh
        run: |
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            choco install innosetup --no-progress -y
          }
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            throw "Inno Setup compiler not found"
          }

          New-Item -ItemType Directory -Path "$env:InstallerOutputDir" -Force | Out-Null
          & $iscc "/DMyAppVersion=$env:APP_VERSION" "/DSourceDir=$env:OutputPath64" "/DOutputDir=$env:InstallerOutputDir" "./installer/ghost-vpn.iss"

      - name: Upload win-x64 artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ghost-vpn-windows-64
          path: ${{ env.ZipPath64 }}
          retention-days: 14

      - name: Upload win-arm64 artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ghost-vpn-windows-arm64
          path: ${{ env.ZipPathArm64 }}
          retention-days: 14

      - name: Upload setup artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ghost-vpn-windows-setup-x64
          path: ${{ env.SetupPath64 }}
          retention-days: 14

      - name: Upload archives to GitHub Release
        if: ${{ github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          prerelease: true
          files: |
            ${{ env.ZipPath64 }}
            ${{ env.ZipPathArm64 }}
            ${{ env.SetupPath64 }}
